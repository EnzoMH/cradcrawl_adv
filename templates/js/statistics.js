/*!
 * Statistics Manager - CRM ÌÜµÍ≥Ñ Î∂ÑÏÑù ÌéòÏù¥ÏßÄ JavaScript
 * Îç∞Ïù¥ÌÑ∞ ÏãúÍ∞ÅÌôî, API Ïó∞Îèô, Ï∞®Ìä∏ Í¥ÄÎ¶¨ Îì±Ïùò Í∏∞Îä• Ï†úÍ≥µ
 */

class StatisticsManager {
    constructor() {
        this.api = new APIClient();
        this.charts = {};
        this.currentSection = 'overview';
        this.data = {};
        this.refreshInterval = null;
        
        this.init();
    }

    async init() {
        console.log('üìä Statistics Manager Ï¥àÍ∏∞Ìôî ÏãúÏûë');
        this.setupEventListeners();
        await this.loadInitialData();
        this.startAutoRefresh();
    }

    setupEventListeners() {
        // ÏÇ¨Ïù¥ÎìúÎ∞î Î©îÎâ¥ ÌÅ¥Î¶≠
        document.querySelectorAll('[data-section]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.currentTarget.dataset.section;
                this.switchSection(section);
            });
        });

        // Ï∞Ω ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Ïãú Ï∞®Ìä∏ Î¶¨ÏÇ¨Ïù¥Ï¶à
        window.addEventListener('resize', this.debounce(() => {
            this.resizeAllCharts();
        }, 250));

        // ÌéòÏù¥ÏßÄ Í∞ÄÏãúÏÑ± Î≥ÄÍ≤Ω Ïãú ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ï†úÏñ¥
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.stopAutoRefresh();
            } else {
                this.startAutoRefresh();
            }
        });
    }

    switchSection(section) {
        console.log(`üîÑ ÏÑπÏÖò Ï†ÑÌôò: ${this.currentSection} ‚Üí ${section}`);
        
        // Ïù¥Ï†Ñ ÏÑπÏÖò Ïà®Í∏∞Í∏∞
        document.querySelectorAll('.statistics-section').forEach(sec => {
            sec.style.display = 'none';
        });

        // ÏÉà ÏÑπÏÖò ÌëúÏãú
        const newSection = document.getElementById(`${section}-section`);
        if (newSection) {
            newSection.style.display = 'block';
        }

        // Î©îÎâ¥ ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω
        document.querySelectorAll('[data-section]').forEach(link => {
            link.classList.remove('active');
        });
        
        const activeLink = document.querySelector(`[data-section="${section}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }

        this.currentSection = section;

        // ÏÑπÏÖòÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        this.loadSectionData(section);
    }

    async loadInitialData() {
        this.showLoading(true);
        
        try {
            console.log('üì° Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë');
            await this.loadOverviewData();
            this.updateLastUpdated();
            console.log('‚úÖ Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å');
        } catch (error) {
            console.error('‚ùå Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            this.showError('Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        } finally {
            this.showLoading(false);
        }
    }

    async loadSectionData(section) {
        // Ïù¥ÎØ∏ Î°úÎìúÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ Ïä§ÌÇµ (Ï∫êÏã±)
        if (this.data[section] && !this.shouldRefreshData(section)) {
            console.log(`üìã Ï∫êÏãúÎêú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©: ${section}`);
            return;
        }

        this.showLoading(true);
        
        try {
            console.log(`üì° ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞ Î°úÎìú: ${section}`);
            
            switch (section) {
                case 'overview':
                    await this.loadOverviewData();
                    break;
                case 'contact-analysis':
                    await this.loadContactAnalysis();
                    break;
                case 'geographic':
                    await this.loadGeographicData();
                    break;
                case 'email-analysis':
                    await this.loadEmailAnalysis();
                    break;
                case 'category-breakdown':
                    await this.loadCategoryBreakdown();
                    break;
                case 'quality-report':
                    await this.loadQualityReport();
                    break;
                default:
                    console.warn(`‚ö†Ô∏è Ïïå Ïàò ÏóÜÎäî ÏÑπÏÖò: ${section}`);
            }
            
            // Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÍ∞Ñ Í∏∞Î°ù
            this.data[`${section}_loaded_at`] = Date.now();
            
        } catch (error) {
            console.error(`‚ùå ${section} Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:`, error);
            this.showError(`${section} Îç∞Ïù¥ÌÑ∞ Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.`);
        } finally {
            this.showLoading(false);
        }
    }

    shouldRefreshData(section) {
        const loadedAt = this.data[`${section}_loaded_at`];
        if (!loadedAt) return true;
        
        // 5Î∂Ñ Ïù¥ÏÉÅ ÏßÄÎÇ¨ÏúºÎ©¥ ÏÉàÎ°úÍ≥†Ïπ®
        return (Date.now() - loadedAt) > 5 * 60 * 1000;
    }

    // ==================== Í∞úÏöî ÏÑπÏÖò ====================
    
    async loadOverviewData() {
        try {
            const response = await this.api.get('/api/statistics/overview');
            this.data.overview = response.data;

            this.updateOverviewCards();
            this.createContactCoverageChart();
            this.createCompletenessChart();
            
        } catch (error) {
            console.error('‚ùå Í∞úÏöî Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            throw error;
        }
    }

    updateOverviewCards() {
        const data = this.data.overview;
        
        this.updateElement('total-orgs', Utils.formatNumber(data.basic_stats?.total_organizations || 0));
        this.updateElement('complete-contacts', Utils.formatNumber(data.basic_stats?.complete_contacts || 0));
        this.updateElement('incomplete-contacts', Utils.formatNumber(data.basic_stats?.incomplete_contacts || 0));
        
        const completionRate = data.quality_metrics?.completeness_rate || 0;
        this.updateElement('completion-rate', `${completionRate}%`);
    }

    createContactCoverageChart() {
        const ctx = document.getElementById('contactCoverageChart');
        if (!ctx) return;
        
        const coverage = this.data.overview.contact_coverage || {};
        
        if (this.charts.contactCoverage) {
            this.charts.contactCoverage.destroy();
        }

        this.charts.contactCoverage = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Ï†ÑÌôîÎ≤àÌò∏', 'Ìå©Ïä§Î≤àÌò∏', 'Ïù¥Î©îÏùº', 'ÌôàÌéòÏù¥ÏßÄ'],
                datasets: [{
                    label: 'Î≥¥Ïú† Í∏∞Í¥Ä Ïàò',
                    data: [
                        coverage.phone?.count || 0,
                        coverage.fax?.count || 0,
                        coverage.email?.count || 0,
                        coverage.homepage?.count || 0
                    ],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(255, 205, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 205, 86, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${Utils.formatNumber(value)}Í∞ú (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return Utils.formatNumber(value);
                            }
                        }
                    }
                }
            }
        });
    }

    createCompletenessChart() {
        const ctx = document.getElementById('completenessChart');
        if (!ctx) return;
        
        const basicStats = this.data.overview.basic_stats || {};
        
        if (this.charts.completeness) {
            this.charts.completeness.destroy();
        }

        const complete = basicStats.complete_contacts || 0;
        const incomplete = basicStats.incomplete_contacts || 0;
        const total = complete + incomplete;

        this.charts.completeness = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['ÏôÑÏ†ÑÌïú Ïó∞ÎùΩÏ≤ò', 'Î∂àÏôÑÏ†ÑÌïú Ïó∞ÎùΩÏ≤ò'],
                datasets: [{
                    data: [complete, incomplete],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(255, 193, 7, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${Utils.formatNumber(value)}Í∞ú (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // ==================== Ïó∞ÎùΩÏ≤ò Î∂ÑÏÑù ÏÑπÏÖò ====================
    
    async loadContactAnalysis() {
        try {
            const response = await this.api.get('/api/statistics/contact-analysis');
            this.data.contactAnalysis = response.analysis;

            this.updateQualityMetrics();
            this.updateContactDetailsTable();
            
        } catch (error) {
            console.error('‚ùå Ïó∞ÎùΩÏ≤ò Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            throw error;
        }
    }

    updateQualityMetrics() {
        const metrics = this.data.contactAnalysis.quality_metrics || {};
        const coverage = this.data.contactAnalysis.contact_coverage || {};
        
        const metricsContainer = document.getElementById('quality-metrics');
        if (!metricsContainer) return;
        
        metricsContainer.innerHTML = '';

        const metricItems = [
            { 
                label: 'Ï†ÑÌôîÎ≤àÌò∏ Ïú†Ìö®ÏÑ±', 
                value: `${Math.round(metrics.phone_validity_rate || 0)}%`, 
                color: 'primary',
                icon: 'telephone'
            },
            { 
                label: 'Ìå©Ïä§Î≤àÌò∏ Ïú†Ìö®ÏÑ±', 
                value: `${Math.round(metrics.fax_validity_rate || 0)}%`, 
                color: 'info',
                icon: 'printer'
            },
            { 
                label: 'Ï†ÑÌôîÎ≤àÌò∏ Î≥¥Ïú†Ïú®', 
                value: `${Math.round(coverage.phone?.rate || 0)}%`, 
                color: 'success',
                icon: 'check-circle'
            },
            { 
                label: 'Ïù¥Î©îÏùº Î≥¥Ïú†Ïú®', 
                value: `${Math.round(coverage.email?.rate || 0)}%`, 
                color: 'warning',
                icon: 'envelope'
            }
        ];

        metricItems.forEach(item => {
            const col = document.createElement('div');
            col.className = 'col-md-3';
            col.innerHTML = `
                <div class="text-center p-3 border rounded">
                    <i class="bi bi-${item.icon} fs-1 text-${item.color} mb-2"></i>
                    <div class="fs-2 fw-bold text-${item.color}">${item.value}</div>
                    <div class="text-muted small">${item.label}</div>
                </div>
            `;
            metricsContainer.appendChild(col);
        });
    }

    updateContactDetailsTable() {
        const coverage = this.data.contactAnalysis.contact_coverage || {};
        const metrics = this.data.contactAnalysis.quality_metrics || {};
        
        const tbody = document.querySelector('#contact-details-table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';

        const contactTypes = [
            { 
                name: 'Ï†ÑÌôîÎ≤àÌò∏', 
                count: coverage.phone?.count || 0, 
                rate: Math.round(coverage.phone?.rate || 0),
                valid: metrics.valid_phones || 0,
                validRate: Math.round(metrics.phone_validity_rate || 0),
                icon: 'telephone'
            },
            { 
                name: 'Ìå©Ïä§Î≤àÌò∏', 
                count: coverage.fax?.count || 0, 
                rate: Math.round(coverage.fax?.rate || 0),
                valid: metrics.valid_faxes || 0,
                validRate: Math.round(metrics.fax_validity_rate || 0),
                icon: 'printer'
            },
            { 
                name: 'Ïù¥Î©îÏùº', 
                count: coverage.email?.count || 0, 
                rate: Math.round(coverage.email?.rate || 0),
                valid: coverage.email?.count || 0,
                validRate: 100,
                icon: 'envelope'
            },
            { 
                name: 'ÌôàÌéòÏù¥ÏßÄ', 
                count: coverage.homepage?.count || 0, 
                rate: Math.round(coverage.homepage?.rate || 0),
                valid: coverage.homepage?.count || 0,
                validRate: 100,
                icon: 'globe'
            }
        ];

        contactTypes.forEach(type => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>
                    <i class="bi bi-${type.icon} me-2"></i>
                    ${type.name}
                </td>
                <td>${Utils.formatNumber(type.count)}</td>
                <td><span class="badge bg-primary">${type.rate}%</span></td>
                <td>${Utils.formatNumber(type.valid)}</td>
                <td><span class="badge bg-success">${type.validRate}%</span></td>
            `;
        });
    }

    // ==================== ÏßÄÏó≠Î≥Ñ Î∂ÑÌè¨ ÏÑπÏÖò ====================
    
    async loadGeographicData() {
        try {
            const response = await this.api.get('/api/statistics/geographic-distribution');
            this.data.geographic = response.geographic_data;

            this.createGeographicChart();
            this.updateTopRegionsList();
            
        } catch (error) {
            console.error('‚ùå ÏßÄÏó≠Î≥Ñ Î∂ÑÌè¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            throw error;
        }
    }

    createGeographicChart() {
        const ctx = document.getElementById('geographicChart');
        if (!ctx) return;
        
        const geoData = this.data.geographic || {};
        
        if (this.charts.geographic) {
            this.charts.geographic.destroy();
        }

        const entries = Object.entries(geoData).slice(0, 10);
        const labels = entries.map(([code, data]) => data.area_name);
        const data = entries.map(([code, data]) => data.total_contacts);

        this.charts.geographic = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ïó∞ÎùΩÏ≤ò Ïàò',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${Utils.formatNumber(context.parsed.x)}Í∞ú`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return Utils.formatNumber(value);
                            }
                        }
                    }
                }
            }
        });
    }

    updateTopRegionsList() {
        const geoData = this.data.geographic || {};
        const container = document.getElementById('top-regions-list');
        if (!container) return;
        
        container.innerHTML = '';

        Object.entries(geoData).slice(0, 5).forEach(([code, data], index) => {
            const item = document.createElement('div');
            item.className = 'd-flex justify-content-between align-items-center mb-3 p-2 border rounded';
            item.innerHTML = `
                <div>
                    <span class="badge bg-primary me-2">${index + 1}</span>
                    <strong>${data.area_name}</strong>
                    <small class="text-muted ms-1">(${code})</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-info">${Utils.formatNumber(data.total_contacts)}Í∞ú</span>
                    <div class="small text-muted">
                        Ï†ÑÌôî: ${data.phone_count || 0} | Ìå©Ïä§: ${data.fax_count || 0}
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    // ==================== Ïù¥Î©îÏùº Î∂ÑÏÑù ÏÑπÏÖò ====================
    
    async loadEmailAnalysis() {
        try {
            const response = await this.api.get('/api/statistics/email-analysis');
            this.data.emailAnalysis = response.email_data;

            this.createEmailCategoryChart();
            this.updateTopDomainsList();
            
        } catch (error) {
            console.error('‚ùå Ïù¥Î©îÏùº Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            throw error;
        }
    }

    createEmailCategoryChart() {
        const ctx = document.getElementById('emailCategoryChart');
        if (!ctx) return;
        
        const categories = this.data.emailAnalysis.domain_categories || {};
        
        if (this.charts.emailCategory) {
            this.charts.emailCategory.destroy();
        }

        const labels = Object.keys(categories);
        const data = Object.values(categories);
        const total = data.reduce((a, b) => a + b, 0);

        this.charts.emailCategory = new Chart(ctx.getContext('2d'), {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 205, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 205, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${Utils.formatNumber(value)}Í∞ú (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    updateTopDomainsList() {
        const domains = this.data.emailAnalysis.top_domains || {};
        const container = document.getElementById('top-domains-list');
        if (!container) return;
        
        container.innerHTML = '';

        Object.entries(domains).slice(0, 10).forEach(([domain, count], index) => {
            const item = document.createElement('div');
            item.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
            item.innerHTML = `
                <div>
                    <span class="badge bg-secondary me-2">${index + 1}</span>
                    <code class="text-primary">${domain}</code>
                </div>
                <span class="badge bg-primary">${Utils.formatNumber(count)}Í∞ú</span>
            `;
            container.appendChild(item);
        });
    }

    // ==================== Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Î∂ÑÏÑù ÏÑπÏÖò ====================
    
    async loadCategoryBreakdown() {
        try {
            const response = await this.api.get('/api/statistics/category-breakdown');
            this.data.categoryBreakdown = response.category_ranking;

            this.updateCategoryRankingTable();
            
        } catch (error) {
            console.error('‚ùå Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            throw error;
        }
    }

    updateCategoryRankingTable() {
        const rankings = this.data.categoryBreakdown || [];
        const tbody = document.querySelector('#category-ranking-table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';

        rankings.forEach((category, index) => {
            const row = tbody.insertRow();
            const avgCoverage = Math.round(category.average_coverage || 0);
            
            // ÏôÑÏÑ±ÎèÑÏóê Îî∞Î•∏ ÏÉâÏÉÅ Í≤∞Ï†ï
            const coverageClass = avgCoverage >= 80 ? 'success' : 
                                avgCoverage >= 60 ? 'warning' : 'danger';
            
            row.innerHTML = `
                <td><span class="badge bg-primary">${index + 1}</span></td>
                <td><strong>${category.category}</strong></td>
                <td>${Utils.formatNumber(category.total_organizations)}</td>
                <td><span class="badge bg-${coverageClass}">${avgCoverage}%</span></td>
                <td>${Math.round(category.coverage_details.phone || 0)}%</td>
                <td>${Math.round(category.coverage_details.fax || 0)}%</td>
                <td>${Math.round(category.coverage_details.email || 0)}%</td>
                <td>${Math.round(category.coverage_details.homepage || 0)}%</td>
            `;
        });
    }

    // ==================== ÌíàÏßà Î¶¨Ìè¨Ìä∏ ÏÑπÏÖò ====================
    
    async loadQualityReport() {
        try {
            const response = await this.api.get('/api/statistics/quality-report');
            this.data.qualityReport = response.report;

            this.updateQualityScore();
            this.updateRecommendations();
            this.createQualityTrendChart();
            
        } catch (error) {
            console.error('‚ùå ÌíàÏßà Î¶¨Ìè¨Ìä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            throw error;
        }
    }

    updateQualityScore() {
        const report = this.data.qualityReport || {};
        const scoreBreakdown = report.score_breakdown || {};
        
        const overallScore = Math.round(report.overall_score || 0);
        
        this.updateElement('overall-quality-score', overallScore);
        this.updateElement('coverage-score', `${Math.round(scoreBreakdown.coverage_score || 0)}Ï†ê`);
        this.updateElement('validity-score', `${Math.round(scoreBreakdown.validity_score || 0)}Ï†ê`);
        this.updateElement('completeness-score', `${Math.round(scoreBreakdown.completeness_score || 0)}Ï†ê`);

        // ÌíàÏßà Ï†êÏàò ÏõêÌòï Ï∞®Ìä∏
        const ctx = document.getElementById('qualityScoreChart');
        if (!ctx) return;
        
        if (this.charts.qualityScore) {
            this.charts.qualityScore.destroy();
        }

        // Ï†êÏàòÏóê Îî∞Î•∏ ÏÉâÏÉÅ Í≤∞Ï†ï
        const scoreColor = overallScore >= 80 ? 'rgba(40, 167, 69, 0.8)' :
                          overallScore >= 60 ? 'rgba(255, 193, 7, 0.8)' :
                          'rgba(220, 53, 69, 0.8)';

        this.charts.qualityScore = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [overallScore, 100 - overallScore],
                    backgroundColor: [scoreColor, 'rgba(233, 236, 239, 0.3)'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                cutout: '70%'
            }
        });
    }

    updateRecommendations() {
        const recommendations = this.data.qualityReport.recommendations || [];
        const container = document.getElementById('recommendations-list');
        if (!container) return;
        
        container.innerHTML = '';

        if (recommendations.length === 0) {
            container.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle me-2"></i>
                    ÌòÑÏû¨ ÌäπÎ≥ÑÌïú Í∞úÏÑ†ÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§. Îç∞Ïù¥ÌÑ∞ ÌíàÏßàÏù¥ ÏñëÌò∏Ìï©ÎãàÎã§!
                </div>
            `;
            return;
        }

        recommendations.forEach((rec, index) => {
            const priorityClass = rec.priority === 'high' ? 'danger' : 
                                rec.priority === 'medium' ? 'warning' : 'info';
            
            const priorityIcon = rec.priority === 'high' ? 'exclamation-triangle-fill' :
                               rec.priority === 'medium' ? 'exclamation-triangle' : 'info-circle';
            
            const item = document.createElement('div');
            item.className = `alert alert-${priorityClass} border-start border-4`;
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-2">
                            <i class="bi bi-${priorityIcon} me-2"></i>
                            ${rec.issue}
                            <span class="badge bg-${priorityClass} ms-2">${rec.priority.toUpperCase()}</span>
                        </h6>
                        <p class="mb-2">${rec.description}</p>
                        <div class="small">
                            <strong class="text-muted">Í∂åÏû• Ï°∞Ïπò:</strong> ${rec.action}
                        </div>
                    </div>
                    <div class="ms-3">
                        <span class="badge bg-light text-dark">#${index + 1}</span>
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    createQualityTrendChart() {
        const ctx = document.getElementById('qualityTrendChart');
        if (!ctx) return;
        
        const enrichmentHistory = this.data.qualityReport.enrichment_history || {};
        
        if (this.charts.qualityTrend) {
            this.charts.qualityTrend.destroy();
        }

        // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÏûÑÏãú Îç∞Ïù¥ÌÑ∞
        const dailyUpdates = enrichmentHistory.daily_updates || {};
        const labels = Object.keys(dailyUpdates).slice(-7);
        const data = Object.values(dailyUpdates).slice(-7);

        // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
        if (labels.length === 0) {
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toISOString().split('T')[0]);
                data.push(Math.floor(Math.random() * 50) + 10);
            }
        }

        this.charts.qualityTrend = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels.map(label => {
                    const date = new Date(label);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                }),
                datasets: [{
                    label: 'ÏùºÏùº ÏóÖÎç∞Ïù¥Ìä∏ Ïàò',
                    data: data,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `ÏóÖÎç∞Ïù¥Ìä∏: ${Utils.formatNumber(context.parsed.y)}Í±¥`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return Utils.formatNumber(value);
                            }
                        }
                    }
                }
            }
        });
    }

    // ==================== Ïú†Ìã∏Î¶¨Ìã∞ Î©îÏÑúÎìú ====================
    
    updateElement(id, content) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = content;
        }
    }

    updateLastUpdated() {
        const now = new Date();
        this.updateElement('last-updated', `ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏: ${Utils.formatDateTime(now)}`);
    }

    resizeAllCharts() {
        Object.values(this.charts).forEach(chart => {
            if (chart && chart.resize) {
                chart.resize();
            }
        });
    }

    showLoading(show) {
        const loading = document.getElementById('loading');
        if (loading) {
            loading.style.display = show ? 'block' : 'none';
        }
    }

    showSuccess(message) {
        const toastBody = document.getElementById('successToastBody');
        const toast = document.getElementById('successToast');
        
        if (toastBody && toast) {
            toastBody.textContent = message;
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
        
        console.log('‚úÖ', message);
    }

    showError(message) {
        const toastBody = document.getElementById('errorToastBody');
        const toast = document.getElementById('errorToast');
        
        if (toastBody && toast) {
            toastBody.textContent = message;
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
        
        console.error('‚ùå', message);
    }

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    startAutoRefresh() {
        // 5Î∂ÑÎßàÎã§ ÌòÑÏû¨ ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
        }
        
        this.refreshInterval = setInterval(() => {
            console.log('üîÑ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìñâ');
            this.loadSectionData(this.currentSection);
        }, 5 * 60 * 1000); // 5Î∂Ñ
    }

    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
        }
    }

    // ==================== Í≥µÍ∞ú API Î©îÏÑúÎìú ====================
    
    async refreshAllData() {
        console.log('üîÑ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë');
        
        // Ï∫êÏãú Î¨¥Ìö®Ìôî
        Object.keys(this.data).forEach(key => {
            if (key.endsWith('_loaded_at')) {
                delete this.data[key];
            }
        });
        
        await this.loadSectionData(this.currentSection);
        this.showSuccess('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÉàÎ°úÍ≥†Ïπ®ÎêòÏóàÏäµÎãàÎã§.');
    }

    generateReport() {
        const modal = document.getElementById('reportModal');
        if (modal) {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
    }

    async confirmGenerateReport() {
        const includeDetails = document.getElementById('includeDetails')?.checked || false;
        
        try {
            this.showLoading(true);
            const response = await this.api.post('/api/statistics/generate-report');
            
            const modal = document.getElementById('reportModal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) bsModal.hide();
            }
            
            this.showSuccess('Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±Ïù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. ÏôÑÎ£åÎêòÎ©¥ ÏïåÎ¶ºÏùÑ Î∞õÏúºÏã§ Ïàò ÏûàÏäµÎãàÎã§.');
            
        } catch (error) {
            console.error('Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ± Ïã§Ìå®:', error);
            this.showError('Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        } finally {
            this.showLoading(false);
        }
    }

    exportData() {
        const modal = document.getElementById('exportModal');
        if (modal) {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
    }

    async confirmExportData() {
        const format = document.getElementById('exportFormat')?.value || 'json';
        const includeDetails = document.getElementById('exportIncludeDetails')?.checked || false;
        
        try {
            this.showLoading(true);
            
            const response = await this.api.get('/api/statistics/export-data', {
                params: {
                    format: format,
                    include_details: includeDetails
                }
            });
            
            // Îç∞Ïù¥ÌÑ∞ Îã§Ïö¥Î°úÎìú
            const content = format === 'json' ? 
                JSON.stringify(response.data, null, 2) : 
                response.data;
                
            const blob = new Blob([content], { 
                type: format === 'json' ? 'application/json' : 'text/csv' 
            });
            
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `statistics_export_${new Date().getTime()}.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            const modal = document.getElementById('exportModal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) bsModal.hide();
            }
            
            this.showSuccess('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Ï°åÏäµÎãàÎã§.');
            
        } catch (error) {
            console.error('Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïã§Ìå®:', error);
            this.showError('Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        } finally {
            this.showLoading(false);
        }
    }
}

// ==================== Ï†ÑÏó≠ Î≥ÄÏàò Î∞è Ìï®Ïàò ====================

let statisticsManager;

// DOM Î°úÎìú ÏôÑÎ£å Ïãú Ï¥àÍ∏∞Ìôî
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä Statistics ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å');
    statisticsManager = new StatisticsManager();
});

// ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
window.addEventListener('beforeunload', function() {
    if (statisticsManager) {
        statisticsManager.stopAutoRefresh();
    }
});

// Ï†ÑÏó≠ Ìï®ÏàòÎì§ (HTMLÏóêÏÑú Ìò∏Ï∂ú)
async function refreshAllData() {
    if (statisticsManager) {
        await statisticsManager.refreshAllData();
    }
}

function generateReport() {
    if (statisticsManager) {
        statisticsManager.generateReport();
    }
}

async function confirmGenerateReport() {
    if (statisticsManager) {
        await statisticsManager.confirmGenerateReport();
    }
}

function exportData() {
    if (statisticsManager) {
        statisticsManager.exportData();
    }
}

async function confirmExportData() {
    if (statisticsManager) {
        await statisticsManager.confirmExportData();
    }
}
